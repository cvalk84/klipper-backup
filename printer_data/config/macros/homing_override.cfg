    [homing_override]
    axes: xyz
    set_position_z: 0
    gcode:

        {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}              #
        {% set z_hop_speed = (printer.configfile.settings['stepper_z'].homing_speed * 30) | float %}    #
        {% set travel_speed = (printer.toolhead.max_velocity * 30) | float %}                           #
        {% set sensorless_variables = printer["gcode_macro _Sensorless_Homing_Variables"] %}            #
        {% set z_hop_distance = sensorless_variables.z_hop_distance | float %}                          # Collect all variables needed for sensorless homing
        {% set first_homed_axis = sensorless_variables.first_homed_axis | string %}                     # from machine config file and _Sensorless_Homing_Variables
        {% set second_homed_axis = sensorless_variables.second_homed_axis | string %}                   #
        {% set safe_x = sensorless_variables.safe_x | float %}                                          #
        {% set safe_y = sensorless_variables.safe_y | float %}                                          #
        {% set safe_z = sensorless_variables.safe_z_enable | abs %}                                     #

        {% if printer.configfile.settings.cartographer is defined %}                                    # Check if a third-party [cartographer] definiton is used
            {% set probe_name = printer.configfile.settings.cartographer %}                             # If [cartographer] is found in config, set 'probe_name' as [cartographer] config string

        {% if printer.configfile.settings.beacon is defined %}                                          # Check if a third-party [probe] definiton is used
        {% elif printer.configfile.settings.beacon is defined %}                                        #                                         
            {% set probe_name = printer.configfile.settings.beacon %}                                   # If [beacon] is found in config, set 'probe_name' as [beacon] config string
        {% elif printer.configfile.settings.probe is defined %}                                         #
            {% set probe_name = printer.configfile.settings.probe %}                                    # If [probe] is found in config, set 'probe_name' as [probe] config string
        {% elif printer.configfile.settings.dockable_probe is defined %}                                #
            {% set probe_name = printer.configfile.settings.dockable_probe %}                           # If [dockable_probe] is found in config, set 'probe_name' as [dockable_probe] config string
        {% elif printer.configfile.settings.bltouch is defined %}                                       #
            {% set probe_name = printer.configfile.settings.bltouch %}                                  # If [bltouch] is found in config, set 'probe_name' as [bltouch] config string
        {% endif %}                                                                                     #

        {% if 'probe' in printer.configfile.settings.stepper_z.endstop_pin %}                           # Check if Z is configured to home with a probe and pull config values for
            {% set probe_x_offset = probe_name.x_offset | float %}                                      # X and Y offsets
            {% set probe_y_offset = probe_name.y_offset | float %}                                      #
        {% else %}                                                                                      #
            {% set probe_x_offset = 0 | float %}                                                        #
            {% set probe_y_offset = 0 | float %}                                                        # If Z if not homed with a probe, set offsets to 0 (do not apply an offset)
        {% endif %}                                                                                     #

        {% if safe_x == -128 %}                                                                         #
            {% set safe_x = (printer.configfile.settings.stepper_x.position_max) /2 %}                  # If safe_x is '-128', set safe_x to the center of the X axis
        {% endif %}                                                                                     #

        {% if probe_x_offset < 0 %}                                                                     #
            {% set safe_x = safe_x + probe_x_offset %}                                                  #
        {% elif probe_x_offset > 0 %}                                                                   # Depending on if probe_x_offset is a positive or negative value, adjust safe_x
            {% set safe_x = safe_x - probe_x_offset %}                                                  # If the machine does not home Z with a probe, an offset is not applied.
        {% endif %}                                                                                     #

        {% if safe_y == -128 %}                                                                         # 
            {% set safe_y = (printer.configfile.settings.stepper_y.position_max) /2 %}                  # If safe_y is '-128', set safe_y to the center of the Y axis
        {% endif %}                                                                                     #

        {% if probe_y_offset < 0 %}                                                                     #
            {% set safe_y = safe_y + probe_y_offset %}                                                  #
        {% elif probe_y_offset > 0 %}                                                                   # Depending on if probe_y_offset is a positive or negative value, adjust safe_y
            {% set safe_y = safe_y - probe_y_offset %}                                                  # If the machine does not home Z with a probe, an offset is not applied.
        {% endif %}                                                                                     #

        {% if z_hop_distance > 0 %}                                                                     # Check if z_hop_distance is greater than zero
          {% if 'x' not in printer.toolhead.homed_axes and 'y' not in printer.toolhead.homed_axes %}    # If X and Y are not homed, move Z to z_hop_distance
            {% if first_homed_axis != 'Z' %}
              G0 Z{z_hop_distance} F{z_hop_speed}                                                       #
            {% endif %}
          {% endif %}                                                                                   #
        {% endif %}                                                                                     #

        {% if first_homed_axis == 'X' %}                                                                # If first_homed_axis is 'X', begin G28 param check
          {% if home_all or 'X' in params %}                                                            #
            _HOME_X                                                                                     # If home_all or 'X' is in params, home X
          {% endif %}                                                                                   #
          {% if home_all or 'Y' in params %}                                                            # If home_all or 'Y' in params, home Y
            _HOME_Y                                                                                     #
          {% endif %}                                                                                   #
        {% endif %}                                                                                     #

        {% if first_homed_axis == 'Y' %}                                                                # If first_homed_axis is 'Y', begin G28 param check
          {% if home_all or 'Y' in params %}                                                            #
            _HOME_Y                                                                                     # if home_all or 'Y' is in params, home Y
          {% endif %}                                                                                   #
          {% if home_all or 'X' in params %}                                                            # If home_all or 'X' in params, home X
            _HOME_X                                                                                     #
          {% endif %}                                                                                   #
        {% endif %}                                                                                     #

        {% if first_homed_axis == 'Z' %}
            {% if home_all or 'Z' in params %}
              _HOME_Z
            {% endif %}
            {% if second_homed_axis == 'X' %}
                {% if home_all or 'X' in params %}
                    _HOME_X
                {% endif %}
                {% if home_all or 'Y' in params %}
                    _HOME_Y
                {% endif %}
            {% endif %}
            {% if second_homed_axis == 'Y' %}
                {% if home_all or 'Y' in params %}
                    _HOME_Y
                {% endif %}
                {% if home_all or 'X' in params %}
                    _HOME_X
                {% endif %}
            {% endif %}
        {% endif %}

        {% if safe_z == True and (home_all or 'Z' in params) and first_homed_axis != 'Z' %}             # If safe_z is true and home_all or 'Z' is in params,
            G0 X{safe_x} Y{safe_y} F{travel_speed}                                                      # Move to the defined safe XY location
        {% endif %}                                                                                     #

        {% if home_all or 'Z' in params %}                                                              #
            {% if first_homed_axis != 'Z'%}
              _HOME_Z
            {% endif %}
        {% endif %}                                                                                     #  
